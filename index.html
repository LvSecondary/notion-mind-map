<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa Mental Avanzado</title>
  <style>
    body { margin:0; background:#1e1e1e; color:white; font-family:sans-serif; overflow:hidden; }
    #toolbar { position:fixed; top:10px; left:10px; background:#333; padding:10px; border-radius:8px; }
    button, select, input { margin:2px; padding:6px 10px; border:none; border-radius:5px; background:#555; color:white; cursor:pointer; }
    button:hover, select:hover, input:hover { background:#777; }
    svg { width:100vw; height:100vh; }
    .node-shape { cursor:move; }
    .node-text { fill:white; font-size:14px; pointer-events:none; }
    line { stroke:white; stroke-width:2; marker-end:url(#arrow); }
  </style>
</head>
<body>
  <div id="toolbar">
    <button onclick="addNode()">‚ûï Nodo</button>
    <button onclick="setMode('connect')">üîó Conectar</button>
    <button onclick="setMode('delete')">‚ùå Borrar</button>
    <button onclick="exportMap()">üíæ Exportar</button>
    <button onclick="importMap()">üìÇ Importar</button>
    <br>
    Forma: 
    <select id="shapeSelect">
      <option value="circle">C√≠rculo</option>
      <option value="rect">Rect√°ngulo</option>
      <option value="hex">Hex√°gono</option>
    </select>
    Color: <input type="color" id="colorFill" value="#4cafef">
    Borde: <input type="color" id="colorStroke" value="#0f172a">
    Tama√±o: <input type="number" id="nodeSize" value="40" min="20" max="100">
  </div>

  <svg id="mindmap">
    <defs>
      <marker id="arrow" markerWidth="10" markerHeight="10" refX="10" refY="3" orient="auto" markerUnits="strokeWidth">
        <path d="M0,0 L0,6 L9,3 z" fill="white" />
      </marker>
    </defs>
  </svg>

  <script>
    const svg = document.getElementById("mindmap");
    let nodeId = 0;
    let mode = "move";
    let selected = null;
    let startNode = null;
    const connections = [];

    function setMode(m) { mode = m; }

    function addNode() {
      const shapeType = document.getElementById("shapeSelect").value;
      const fillColor = document.getElementById("colorFill").value;
      const strokeColor = document.getElementById("colorStroke").value;
      const size = parseInt(document.getElementById("nodeSize").value);

      const g = document.createElementNS("http://www.w3.org/2000/svg","g");
      g.setAttribute("class","node-group");
      g.setAttribute("transform",`translate(${150+nodeId*30},150)`);
      g.dataset.id = nodeId;

      let shape;
      if (shapeType === "circle") {
        shape = document.createElementNS("http://www.w3.org/2000/svg","circle");
        shape.setAttribute("r", size);
        shape.setAttribute("cx", 0);
        shape.setAttribute("cy", 0);
      } else if (shapeType === "rect") {
        shape = document.createElementNS("http://www.w3.org/2000/svg","rect");
        shape.setAttribute("x", -size);
        shape.setAttribute("y", -size/2);
        shape.setAttribute("width", size*2);
        shape.setAttribute("height", size);
        shape.setAttribute("rx", 10);
      } else if (shapeType === "hex") {
        shape = document.createElementNS("http://www.w3.org/2000/svg","polygon");
        let points = [];
        for (let i=0; i<6; i++) {
          let angle = Math.PI/3 * i;
          points.push(`${Math.cos(angle)*size},${Math.sin(angle)*size}`);
        }
        shape.setAttribute("points", points.join(" "));
      }

      shape.setAttribute("fill", fillColor);
      shape.setAttribute("stroke", strokeColor);
      shape.setAttribute("stroke-width", 2);
      shape.setAttribute("class","node-shape");

      const text = document.createElementNS("http://www.w3.org/2000/svg","text");
      text.setAttribute("class","node-text");
      text.setAttribute("text-anchor","middle");
      text.setAttribute("dy",".3em");
      text.textContent = "Nodo "+nodeId;

      g.appendChild(shape);
      g.appendChild(text);
      svg.appendChild(g);

      g.addEventListener("mousedown", startDrag);
      g.addEventListener("mouseup", endDrag);
      g.addEventListener("dblclick", editText);
      g.addEventListener("click", handleClick);

      nodeId++;
    }

    function editText(e) {
      const textEl = e.currentTarget.querySelector("text");
      const newText = prompt("Editar texto:", textEl.textContent);
      if (newText) textEl.textContent = newText;
    }

    function startDrag(e) {
      if (mode==="move") {
        selected = e.currentTarget;
        svg.addEventListener("mousemove", drag);
      }
    }
    function drag(e) {
      if (selected) {
        const CTM = svg.getScreenCTM();
        const x = (e.clientX - CTM.e) / CTM.a;
        const y = (e.clientY - CTM.f) / CTM.d;
        selected.setAttribute("transform",`translate(${x},${y})`);
        updateConnections();
      }
    }
    function endDrag() {
      selected=null;
      svg.removeEventListener("mousemove", drag);
    }

    function handleClick(e) {
      const g = e.currentTarget;
      if (mode==="connect") {
        if (!startNode) {
          startNode=g;
        } else {
          const line = document.createElementNS("http://www.w3.org/2000/svg","line");
          svg.insertBefore(line,svg.firstChild);
          connections.push({line,start:startNode,end:g});
          updateConnections();
          startNode=null;
          mode="move";
        }
      } else if (mode==="delete") {
        // borrar nodo y conexiones asociadas
        for (let i=connections.length-1;i>=0;i--) {
          if (connections[i].start===g || connections[i].end===g) {
            connections[i].line.remove();
            connections.splice(i,1);
          }
        }
        g.remove();
        mode="move";
      }
    }

    function getCenter(g) {
      const transform=g.getAttribute("transform");
      const match=transform.match(/translate\(([^,]+),([^\)]+)\)/);
      return [parseFloat(match[1]), parseFloat(match[2])];
    }

    function updateConnections() {
      connections.forEach(conn=>{
        const [x1,y1]=getCenter(conn.start);
        const [x2,y2]=getCenter(conn.end);
        conn.line.setAttribute("x1",x1);
        conn.line.setAttribute("y1",y1);
        conn.line.setAttribute("x2",x2);
        conn.line.setAttribute("y2",y2);
      });
    }

    function exportMap() {
      const data = {
        nodes: [],
        connections: []
      };
      document.querySelectorAll(".node-group").forEach(g=>{
        data.nodes.push({
          id: g.dataset.id,
          transform: g.getAttribute("transform"),
          text: g.querySelector("text").textContent,
          shape: g.querySelector(".node-shape").outerHTML
        });
      });
      connections.forEach(c=>{
        data.connections.push({
          start: c.start.dataset.id,
          end: c.end.dataset.id
        });
      });
      const blob = new Blob([JSON.stringify(data)],{type:"application/json"});
      const a = document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="mapa.json";
      a.click();
    }

    function importMap() {
      const input=document.createElement("input");
      input.type="file";
      input.accept=".json";
      input.onchange=e=>{
        const file=e.target.files[0];
        const reader=new FileReader();
        reader.onload=()=>{
          const data=JSON.parse(reader.result);
          svg.querySelectorAll(".node-group, line").forEach(el=>el.remove());
          connections.length=0;
          nodeId=0;
          data.nodes.forEach(n=>{
            const g=document.createElementNS("http://www.w3.org/2000/svg","g");
            g.setAttribute("class","node-group");
            g.setAttribute("transform",n.transform);
            g.dataset.id=n.id;
            g.innerHTML=n.shape+`<text class="node-text" text-anchor="middle" dy=".3em">${n.text}</text>`;
            svg.appendChild(g);
            g.addEventListener("mousedown", startDrag);
            g.addEventListener("mouseup", endDrag);
            g.addEventListener("dblclick", editText);
            g.addEventListener("click", handleClick);
            nodeId=Math.max(nodeId,parseInt(n.id)+1);
          });
          data.connections.forEach(c=>{
            const start=document.querySelector(`.node-group[data-id="${c.start}"]`);
            const end=document.querySelector(`.node-group[data-id="${c.end}"]`);
            const line=document.createElementNS("http://www.w3.org/2000/svg","line");
            svg.insertBefore(line,svg.firstChild);
            connections.push({line,start,end});
          });
          updateConnections();
        };
        reader.readAsText(file);
      };
      input.click();
    }
  </script>
</body>
</html>
